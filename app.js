var ASSETS,ENEMY_SIZE,SCREEN_BACKGROUND_COLOR,SCREEN_HEIGHT,SCREEN_WIDTH,SHOOTER_BOTTOM_LIMIT,SHOOTER_LEFT_LIMIT,SHOOTER_RIGHT_LIMIT,SHOOTER_SIZE,SHOOTER_TOP_LIMIT,screen_direction;SCREEN_WIDTH=640,SCREEN_HEIGHT=960,SCREEN_BACKGROUND_COLOR="#555555",screen_direction=0,ASSETS={shooter:"img/shooter.png",enemy:"img/enemy.png",speaker0:"img/speaker0.png",speaker1:"img/speaker1.png",start:"sound/btn09."+tm.sound.Sound.SUPPORT_EXT,died:"sound/btn11."+tm.sound.Sound.SUPPORT_EXT,bgm:"sound/nv_01."+tm.sound.Sound.SUPPORT_EXT},SHOOTER_SIZE=32,ENEMY_SIZE=16,SHOOTER_RIGHT_LIMIT=SCREEN_WIDTH-SHOOTER_SIZE/2,SHOOTER_LEFT_LIMIT=SHOOTER_SIZE/2,SHOOTER_TOP_LIMIT=SHOOTER_SIZE/2,SHOOTER_BOTTOM_LIMIT=SCREEN_HEIGHT-SHOOTER_SIZE/2,tm.main(function(){var t,e,i,n,o;t=tm.display.CanvasApp("#app"),t.resize(SCREEN_WIDTH,SCREEN_HEIGHT),t.fitWindow(),t.background=SCREEN_BACKGROUND_COLOR,o=LoadScene({assets:ASSETS,width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),o.onload=function(){t.replaceScene(TitleScene())},t.replaceScene(o),e=!1,document.getElementById("app").addEventListener("touchstart",n=function(t){return e?!1:(e=!0,tm.sound.WebAudio.unlock(),window.removeEventListener("touchstart",n))}),screen_direction=getDirection(),i=isIOS?"orientationchange":"resize",window.addEventListener(i,function(){screen_direction=getDirection()}),t.run()}),tm.define("Shooter",{superClass:"tm.app.AnimationSprite",init:function(){this.superInit(tm.asset.SpriteSheet({image:"shooter",frame:{width:32,height:32,count:8},animations:{normal:[0,1,"normal"],right:[1,2,"right"],left:[2,3,"left"],explode:[4,8,"died"],died:[7,8,"died"]}})),this.speed=8,this.gotoAndStop("normal")},update:function(t){var e,i,n,o,s,a,r,u,h,l,d,m,c,p,S,g,E;if(this.moved=!1,(t.keyboard.getKey("D")||t.keyboard.getKey("right"))&&this.goRight(),(t.keyboard.getKey("A")||t.keyboard.getKey("left"))&&this.goLeft(),(t.keyboard.getKey("W")||t.keyboard.getKey("up"))&&this.goUp(),(t.keyboard.getKey("S")||t.keyboard.getKey("down"))&&this.goDown(),isMobile)switch(E=t.accelerometer.orientation,screen_direction){case 0:10<(e=E.gamma)&&90>e&&this.goRight(),-90<(i=E.gamma)&&-10>i&&this.goLeft(),-180<(h=E.beta)&&-10>h&&this.goUp(),10<(l=E.beta)&&180>l&&this.goDown();break;case 1:10<(d=E.gamma)&&90>d&&this.goUp(),-90<(m=E.gamma)&&-10>m&&this.goDown(),-180<(c=E.beta)&&-10>c&&this.goLeft(),10<(p=E.beta)&&180>p&&this.goRight();break;case 2:10<(S=E.gamma)&&90>S&&this.goLeft(),-90<(g=E.gamma)&&-10>g&&this.goRight(),-180<(n=E.beta)&&-10>n&&this.goDown(),10<(o=E.beta)&&180>o&&this.goUp();break;case 3:10<(s=E.gamma)&&90>s&&this.goDown(),-90<(a=E.gamma)&&-10>a&&this.goUp(),-180<(r=E.beta)&&-10>r&&this.goRight(),10<(u=E.beta)&&180>u&&this.goLeft()}this.moved||"died"===this.currentAnimation.next||this.gotoAndPlay("normal"),this.ensureMoveLimit()},goRight:function(){this.moved=!0,this.x+=this.speed,this.gotoAndPlay("right")},goLeft:function(){this.moved=!0,this.x-=this.speed,this.gotoAndPlay("left")},goUp:function(){this.moved=!0,this.y-=this.speed,this.gotoAndPlay("normal")},goDown:function(){this.moved=!0,this.y+=this.speed,this.gotoAndPlay("normal")},ensureMoveLimit:function(){this.x<SHOOTER_LEFT_LIMIT&&(this.x=SHOOTER_LEFT_LIMIT),this.x>SHOOTER_RIGHT_LIMIT&&(this.x=SHOOTER_RIGHT_LIMIT),this.y<SHOOTER_TOP_LIMIT&&(this.y=SHOOTER_TOP_LIMIT),this.y>SHOOTER_BOTTOM_LIMIT&&(this.y=SHOOTER_BOTTOM_LIMIT)}}),tm.define("Enemy",{superClass:"tm.app.Sprite",init:function(){this.superInit("enemy",ENEMY_SIZE,ENEMY_SIZE),this.speed=Math.rand(6,12)},update:function(){this.y+=this.speed,this.y>SCREEN_HEIGHT+this.height&&this.remove()}}),tm.define("Bullet",{superClass:"tm.display.CircleShape",init:function(t,e,i){this.superInit({width:15,height:15,fillStyle:t,strokeStyle:e}),this.speed=i},update:function(){this.y+=this.speed,(this.y<0||SCREEN_HEIGHT+this.height<this.y)&&this.remove()}}),tm.define("LoadScene",{superClass:"tm.game.LoadingScene",init:function(t){this.superInit(t)}}),tm.define("TitleScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:[{type:"Label",name:"titleLabel",text:"Shooting!",x:SCREEN_WIDTH/2,y:360,fillStyle:"#FFFFFF",fontSize:60,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"Label",name:"soundCautionLabel",text:"音が流れます",x:SCREEN_WIDTH/2,y:700,fillStyle:"#FFFFFF",fontSize:26,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"FlatButton",name:"startButton",init:[{text:"Start",fontFamily:"メイリオ",fontSize:26,width:160,height:40}],x:SCREEN_WIDTH/2,y:800},{type:"FlatButton",name:"discriptionButton",init:[{text:"操作方法",fontSize:20,fontFamily:"メイリオ",width:160,height:40}],x:SCREEN_WIDTH/2,y:900},{type:"FlatButton",name:"muteButton",init:[{text:"",fontFamily:"メイリオ",width:60,height:60}],x:30,y:30}]}),this.startButton.label.tweener.fadeOut(500).fadeIn(1e3).setLoop(!0),tm.sound.SoundManager.isMute()?this.muteIcon=tm.display.Sprite("speaker0",32,32).addChildTo(this.muteButton):this.muteIcon=tm.display.Sprite("speaker1",32,32).addChildTo(this.muteButton),this.muteButton.onpointingstart=function(t){return function(){tm.sound.SoundManager.mute(),tm.sound.SoundManager.isMute()?t.muteIcon.setImage("speaker0"):t.muteIcon.setImage("speaker1")}}(this),this.startButton.onpointingstart=function(t){return function(){tm.sound.SoundManager.play("start",1,0,!1),t.app.replaceScene(GameScene())}}(this),this.discriptionButton.onpointingstart=function(t){return function(){var t;t=window.open("help.html"),null==t&&(document.location="help.html")}}(this)},update:function(t){t.keyboard.getKeyDown("ctrl")&&(tm.sound.SoundManager.mute(),tm.sound.SoundManager.isMute()?this.muteIcon.setImage("speaker0"):this.muteIcon.setImage("speaker1"))}}),tm.define("GameScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:[{type:"FlatButton",name:"pauseButton",init:[{text:"||",fontSize:40,fontFamily:"メイリオ",width:60,height:60}],x:30,y:30},{type:"FlatButton",name:"muteButton",init:[{text:"",fontFamily:"メイリオ",width:60,height:60}],x:30,y:90}]}),this.pauseButton.onpointingstart=function(t){return function(){t.app.pushScene(PauseScene())}}(this),tm.sound.SoundManager.playMusic("bgm",!0,1),tm.sound.SoundManager.isMute()?this.muteIcon=tm.display.Sprite("speaker0",32,32).addChildTo(this.muteButton):this.muteIcon=tm.display.Sprite("speaker1",32,32).addChildTo(this.muteButton),this.muteButton.onpointingstart=function(t){return function(){tm.sound.SoundManager.mute(),tm.sound.SoundManager.isMute()?t.muteIcon.setImage("speaker0"):t.muteIcon.setImage("speaker1")}}(this),this.shooter=Shooter().addChildTo(this),this.shooter.position.set(SCREEN_WIDTH/2,800),this.waitTimeBullet=0,this.WAIT_TIME_BULLET_LIMIT=5,this.shooterBulletGroup=tm.app.CanvasElement().addChildTo(this),this.enemyGroup=tm.app.CanvasElement().addChildTo(this),this.enemyBulletGroup=tm.app.CanvasElement().addChildTo(this),this.timer=0,this.hit=0,this.seconds=tm.display.Label("").setPosition(SCREEN_WIDTH-10,10).setBaseline("top").setAlign("right").addChildTo(this),this.seconds.update=function(t){return function(e){t.seconds.text=(Math.floor(100*t.timer/30)/100).toFixed(2)+"秒"}}(this)},update:function(t){var e,i,n,o,s,a,r;if(this.timer++,t.keyboard.getKey("shift")&&this.app.pushScene(PauseScene()),t.keyboard.getKeyDown("ctrl")&&(tm.sound.SoundManager.mute(),tm.sound.SoundManager.isMute()?this.muteIcon.setImage("speaker0"):this.muteIcon.setImage("speaker1")),this.waitTimeBullet<0&&(t.keyboard.getKey("space")||t.keyboard.getKey("R")||t.pointing.getPointing())&&(this.waitTimeBullet=this.WAIT_TIME_BULLET_LIMIT,e=Bullet("blue","white",-20),e.position.set(this.shooter.x,this.shooter.y-30),e.addChildTo(this.shooterBulletGroup)),--this.waitTimeBullet,this.timer%30===0)for(a=this.timer/300,n=o=0,r=a;r>=0?r>=o:o>=r;n=r>=0?++o:--o)i=Enemy().addChildTo(this.enemyGroup),i.x=Math.rand(ENEMY_SIZE,SCREEN_WIDTH-ENEMY_SIZE),i.y=0-i.height;this.timer%30===0&&(a=this.timer/60,s=Math.rand(0,a),this.enemyGroup.children.each(function(t){return function(i){return s>0&&i.y<SCREEN_HEIGHT/2?(s--,e=Bullet("red","black",20),e.position.set(i.x,i.y+30),e.addChildTo(t.enemyBulletGroup)):void 0}}(this))),this.enemyGroup.children.each(function(t){return function(e){t.shooter.isHitElement(e)&&(e.remove(),t.shooterDied()),t.shooterBulletGroup.children.each(function(i){e.isHitElement(i)&&(e.remove(),i.remove(),t.hit++)})}}(this)),this.enemyBulletGroup.children.each(function(t){return function(e){return t.shooter.isHitElement(e)&&(e.remove(),t.shooterDied()),t.shooterBulletGroup.children.each(function(t){return e.isHitElement(t)?(e.remove(),t.remove()):void 0})}}(this))},onblur:function(){this.app.pushScene(PauseScene())},shooterDied:function(){tm.sound.SoundManager.stopMusic(),tm.sound.SoundManager.play("died",1,0,!1),this.shooter.gotoAndPlay("explode"),setTimeout(function(t){return function(){t.app.replaceScene(ResultScene(t.timer,t.hit))}}(this),100)}}),tm.define("PauseScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:[{type:"RectangleShape",width:SCREEN_WIDTH,height:SCREEN_HEIGHT,fillStyle:"rgba(0, 0, 0, 0.4)",originX:0,originY:0},{type:"Label",name:"titleLabel",text:"Pause",x:SCREEN_WIDTH/2,y:360,fillStyle:"#FFFFFF",fontSize:60,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"FlatButton",name:"helpButton",init:[{text:"操作方法",fontSize:20,fontFamily:"メイリオ",width:200,height:80}],x:SCREEN_WIDTH/2,y:600},{type:"FlatButton",name:"backButton",init:[{text:"再開する",fontSize:26,fontFamily:"メイリオ"}],x:SCREEN_WIDTH/2,y:800}]}),tm.sound.SoundManager.pauseMusic(),this.helpButton.onpointingstart=function(t){return function(){var t;t=window.open("help.html"),null==t&&window.confirm("途中で確認すると最初からやり直しになりますが、よろしいですか？")&&(document.location="help.html")}}(this),this.backButton.onpointingstart=function(t){return function(){tm.sound.SoundManager.resumeMusic(),t.app.popScene()}}(this)},update:function(t){t.keyboard.getKey("escape")&&this.app.popScene()},onfocus:function(){this.app.start()},onblur:function(){this.app.stop()}}),tm.define("ResultScene",{superClass:"tm.app.Scene",init:function(t,e){this.superInit(),this.timeFormated=Math.floor(100*t/30)/100,this.score=t+10*e,this.fromJSON({children:[{type:"FlatButton",name:"creditButton",init:[{text:"クレジット",fontSize:14,fontFamily:"メイリオ",width:100,height:40}],x:SCREEN_WIDTH-70,y:40},{type:"Label",name:"titleLabel",text:"Result",x:SCREEN_WIDTH/2,y:300,fillStyle:"#FFFFFF",fontSize:60,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"Label",name:"titleLabel",text:this.timeFormated+"秒 "+e+"ヒット",x:SCREEN_WIDTH/2,y:400,fillStyle:"#CCCCFF",fontSize:36,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"Label",name:"titleLabel",text:"Score: "+this.score,x:SCREEN_WIDTH/2,y:500,fillStyle:"#CCCCFF",fontSize:36,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"FlatButton",name:"tweetButton",init:[{text:"Twitterでつぶやく",fontSize:22,fontFamily:"メイリオ",width:200,height:80}],x:SCREEN_WIDTH/2,y:600},{type:"FlatButton",name:"backButton",init:[{text:"タイトルに戻る",fontSize:26,fontFamily:"メイリオ"}],x:SCREEN_WIDTH/2,y:800}]}),this.creditButton.onpointingstart=function(i){return function(){i.app.replaceScene(CreditScene(t,e))}}(this),this.tweetButton.onpointingstart=function(t){return function(){var i,n;n=tm.social.Twitter.createURL({type:"tweet",text:"Shooting! "+t.timeFormated+"秒間生き残り、"+e+"ヒットしました！ Score: "+t.score,hashtags:"tmlib, shooting!",url:window.document.location.href}),i=window.open(n),null==i&&(document.location=n)}}(this),this.backButton.onpointingstart=function(t){return function(){t.app.replaceScene(TitleScene())}}(this)}}),tm.define("CreditScene",{superClass:"tm.app.Scene",init:function(t,e){this.superInit(),this.fromJSON({children:[{type:"Label",name:"titleLabel",text:"Credit",x:SCREEN_WIDTH/2,y:100,fillStyle:"#FFFFFF",fontSize:60,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"Label",name:"titleLabel",text:"--- Build Tools etc. ---\nbower\nnpm\ngulp\n--- Libraries ---\npure\ntmlib.js\n--- Sounds ---\nMusMus",x:SCREEN_WIDTH/2,y:200,fillStyle:"#CCCCFF",fontSize:36,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"FlatButton",name:"backButton",init:[{text:"戻る",fontSize:26,fontFamily:"メイリオ",align:"center",baseline:"middle"}],x:SCREEN_WIDTH/2,y:800}]}),this.backButton.onpointingstart=function(i){return function(){i.app.replaceScene(ResultScene(t,e))}}(this)}});var getDirection,isIOS,isMobile;isIOS=function(){return navigator.userAgent.match(/(?:iPhone|iPod|iPad)/)},isMobile=function(){return navigator.userAgent.match(/(?:iPhone|iPod|iPad|Android|Windows Phone|BlackBerry|Mobile|Touch|Tablet)/)},getDirection=function(){var t;if(t=0,null!=window.orientation)switch(window.orientation){case 0:t=0;break;case 90:t=1;break;case 180:t=2;break;case-90:t=3}return t};