var ASSETS,ENEMY_SIZE,SCREEN_BACKGROUND_COLOR,SCREEN_HEIGHT,SCREEN_WIDTH,SHOOTER_BOTTOM_LIMIT,SHOOTER_LEFT_LIMIT,SHOOTER_RIGHT_LIMIT,SHOOTER_SIZE,SHOOTER_TOP_LIMIT,screen_direction;SCREEN_WIDTH=640,SCREEN_HEIGHT=960,SCREEN_BACKGROUND_COLOR="#555555",screen_direction=0,ASSETS={shooter:"img/shooter.png",enemy:"img/enemy.png",speaker0:"img/speaker0.png",speaker1:"img/speaker1.png",start:"sound/btn09."+tm.sound.Sound.SUPPORT_EXT,died:"sound/btn11."+tm.sound.Sound.SUPPORT_EXT,bgm:"sound/nv_01."+tm.sound.Sound.SUPPORT_EXT},SHOOTER_SIZE=32,ENEMY_SIZE=16,SHOOTER_RIGHT_LIMIT=SCREEN_WIDTH-SHOOTER_SIZE/2,SHOOTER_LEFT_LIMIT=SHOOTER_SIZE/2,SHOOTER_TOP_LIMIT=SHOOTER_SIZE/2,SHOOTER_BOTTOM_LIMIT=SCREEN_HEIGHT-SHOOTER_SIZE/2,tm.main(function(){var t,e,i,n,o;t=tm.display.CanvasApp("#app"),t.resize(SCREEN_WIDTH,SCREEN_HEIGHT),t.fitWindow(),t.background=SCREEN_BACKGROUND_COLOR,t.fps=60,o=LoadScene({assets:ASSETS,width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),o.onload=function(){t.replaceScene(TitleScene())},t.replaceScene(o),e=!1,document.getElementById("app").addEventListener("touchstart",n=function(t){return e?!1:(e=!0,tm.sound.WebAudio.unlock(),window.removeEventListener("touchstart",n))}),screen_direction=getDirection(),i=isIOS?"orientationchange":"resize",window.addEventListener(i,function(){screen_direction=getDirection()}),t.run()}),tm.define("Shooter",{superClass:"tm.app.AnimationSprite",init:function(){this.superInit(tm.asset.SpriteSheet({image:"shooter",frame:{width:32,height:32,count:8},animations:{normal:[0,1,"normal"],right:[1,2,"right"],left:[2,3,"left"],explode:[4,8,"died"],died:[7,8,"died"]}})),this.speed=4,this.canMove=!0,this.gotoAndStop("normal")},update:function(t){var e,i,n,o,s,a,h,r,u,l,d,m,c,p,S,f,E;if(this.moved=!1,this.canMove){if((t.keyboard.getKey("D")||t.keyboard.getKey("right"))&&this.goRight(),(t.keyboard.getKey("A")||t.keyboard.getKey("left"))&&this.goLeft(),(t.keyboard.getKey("W")||t.keyboard.getKey("up"))&&this.goUp(),(t.keyboard.getKey("S")||t.keyboard.getKey("down"))&&this.goDown(),isMobile)switch(E=t.accelerometer.orientation,screen_direction){case 0:10<(e=E.gamma)&&90>e&&this.goRight(),-90<(i=E.gamma)&&-10>i&&this.goLeft(),-180<(u=E.beta)&&-10>u&&this.goUp(),10<(l=E.beta)&&180>l&&this.goDown();break;case 1:10<(d=E.gamma)&&90>d&&this.goUp(),-90<(m=E.gamma)&&-10>m&&this.goDown(),-180<(c=E.beta)&&-10>c&&this.goLeft(),10<(p=E.beta)&&180>p&&this.goRight();break;case 2:10<(S=E.gamma)&&90>S&&this.goLeft(),-90<(f=E.gamma)&&-10>f&&this.goRight(),-180<(n=E.beta)&&-10>n&&this.goDown(),10<(o=E.beta)&&180>o&&this.goUp();break;case 3:10<(s=E.gamma)&&90>s&&this.goDown(),-90<(a=E.gamma)&&-10>a&&this.goUp(),-180<(h=E.beta)&&-10>h&&this.goRight(),10<(r=E.beta)&&180>r&&this.goLeft()}this.moved||"died"===this.currentAnimation.next||this.gotoAndPlay("normal")}this.ensureMoveLimit()},goRight:function(){this.moved=!0,this.x+=this.speed,this.gotoAndPlay("right")},goLeft:function(){this.moved=!0,this.x-=this.speed,this.gotoAndPlay("left")},goUp:function(){this.moved=!0,this.y-=this.speed,this.gotoAndPlay("normal")},goDown:function(){this.moved=!0,this.y+=this.speed,this.gotoAndPlay("normal")},ensureMoveLimit:function(){this.x<SHOOTER_LEFT_LIMIT&&(this.x=SHOOTER_LEFT_LIMIT),this.x>SHOOTER_RIGHT_LIMIT&&(this.x=SHOOTER_RIGHT_LIMIT),this.y<SHOOTER_TOP_LIMIT&&(this.y=SHOOTER_TOP_LIMIT),this.y>SHOOTER_BOTTOM_LIMIT&&(this.y=SHOOTER_BOTTOM_LIMIT)}}),tm.define("Enemy",{superClass:"tm.app.Sprite",init:function(){this.superInit("enemy",ENEMY_SIZE,ENEMY_SIZE),this.speed=Math.rand(3,6)},update:function(){this.y+=this.speed,this.y>SCREEN_HEIGHT+this.height&&"function"==typeof this&&this(remove())}}),tm.define("Bullet",{superClass:"tm.display.CircleShape",init:function(t,e,i,n){this.superInit({width:i,height:i,fillStyle:t,strokeStyle:e}),this.speed=n,this.released=!1},update:function(){this.y+=this.speed,(this.y<0||SCREEN_HEIGHT+this.height<this.y)&&"function"==typeof this&&this(remove())},sizeSet:function(t){this.width=t,this.height=t},sizeGet:function(){return this.width}}),tm.define("LoadScene",{superClass:"tm.game.LoadingScene",init:function(t){this.superInit(t)}}),tm.define("TitleScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:[{type:"Label",name:"titleLabel",text:"Shooting!",x:SCREEN_WIDTH/2,y:360,fillStyle:"#FFFFFF",fontSize:60,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"Label",name:"soundCautionLabel",text:"音が流れます",x:SCREEN_WIDTH/2,y:700,fillStyle:"#FFFFFF",fontSize:26,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"FlatButton",name:"startButton",init:[{text:"Start",fontFamily:"メイリオ",fontSize:26,width:160,height:40}],x:SCREEN_WIDTH/2,y:800},{type:"FlatButton",name:"discriptionButton",init:[{text:"操作方法",fontSize:20,fontFamily:"メイリオ",width:160,height:40}],x:SCREEN_WIDTH/2,y:900},{type:"FlatButton",name:"muteButton",init:[{text:"",fontFamily:"メイリオ",width:60,height:60}],x:30,y:30}]}),this.startButton.label.tweener.fadeOut(500).fadeIn(1e3).setLoop(!0),tm.sound.SoundManager.isMute()?this.muteIcon=tm.display.Sprite("speaker0",32,32).addChildTo(this.muteButton):this.muteIcon=tm.display.Sprite("speaker1",32,32).addChildTo(this.muteButton),this.muteButton.onpointingstart=function(t){return function(){tm.sound.SoundManager.mute(),tm.sound.SoundManager.isMute()?t.muteIcon.setImage("speaker0"):t.muteIcon.setImage("speaker1")}}(this),this.startButton.onpointingstart=function(t){return function(){tm.sound.SoundManager.play("start",1,0,!1),t.app.replaceScene(GameScene())}}(this),this.discriptionButton.onpointingstart=function(t){return function(){var t;t=window.open("help.html"),null==t&&(document.location="help.html")}}(this)},update:function(t){t.keyboard.getKeyDown("ctrl")&&(tm.sound.SoundManager.mute(),tm.sound.SoundManager.isMute()?this.muteIcon.setImage("speaker0"):this.muteIcon.setImage("speaker1"))}}),tm.define("GameScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:[{type:"FlatButton",name:"pauseButton",init:[{text:"||",fontSize:40,fontFamily:"メイリオ",width:60,height:60}],x:30,y:30},{type:"FlatButton",name:"muteButton",init:[{text:"",fontFamily:"メイリオ",width:60,height:60}],x:30,y:90}]}),this.pauseButton.onpointingstart=function(t){return function(){t.app.pushScene(PauseScene())}}(this),tm.sound.SoundManager.playMusic("bgm",!0,1),tm.sound.SoundManager.isMute()?this.muteIcon=tm.display.Sprite("speaker0",32,32).addChildTo(this.muteButton):this.muteIcon=tm.display.Sprite("speaker1",32,32).addChildTo(this.muteButton),this.muteButton.onpointingstart=function(t){return function(){tm.sound.SoundManager.mute(),tm.sound.SoundManager.isMute()?t.muteIcon.setImage("speaker0"):t.muteIcon.setImage("speaker1")}}(this),this.shooter=Shooter().addChildTo(this),this.shooter.position.set(SCREEN_WIDTH/2,800),this.waitTimeBullet=0,this.WAIT_TIME_BULLET_LIMIT=5,this.shooterBulletGroup=tm.app.CanvasElement().addChildTo(this),this.stored=!1,this.storedTime=0,this.enemyGroup=tm.app.CanvasElement().addChildTo(this),this.enemyBulletGroup=tm.app.CanvasElement().addChildTo(this),this.timer=0,this.hit=0,this.bulletHit=0,this.seconds=tm.display.Label("").setPosition(SCREEN_WIDTH-10,10).setBaseline("top").setAlign("right").addChildTo(this),this.seconds.update=function(t){return function(e){t.seconds.text=(Math.floor(100*t.timer/30)/100).toFixed(2)+"秒"}}(this)},update:function(t){var e,i,n,o,s,a;if(this.timer++,t.keyboard.getKey("shift")&&this.app.pushScene(PauseScene()),t.keyboard.getKeyDown("ctrl")&&(tm.sound.SoundManager.mute(),tm.sound.SoundManager.isMute()?this.muteIcon.setImage("speaker0"):this.muteIcon.setImage("speaker1")),t.keyboard.getKey("space")||t.keyboard.getKey("R")||t.pointing.getPointing()?this.waitTimeBullet<0&&(this.stored?(this.timer%10===0&&this.storedTime++,10<this.storedTime&&(this.storedTime=10),this.shooterBullet.position.set(this.shooter.x,this.shooter.y-30),this.shooterBullet.sizeSet(15+this.storedTime)):(this.stored=!0,this.shooterBullet=Bullet("blue","white",15,0),this.shooterBullet.position.set(this.shooter.x,this.shooter.y-30),this.shooterBullet.addChildTo(this.shooterBulletGroup))):this.stored&&(this.stored=!1,this.storedTime=0,this.shooterBullet.released=!0,this.shooterBullet.speed=-10+this.storedTime,this.waitTimeBullet=this.WAIT_TIME_BULLET_LIMIT),this.waitTimeBullet--,this.timer%30===0)for(s=this.timer/300,i=n=0,a=s;a>=0?a>=n:n>=a;i=a>=0?++n:--n)e=Enemy().addChildTo(this.enemyGroup),e.x=Math.rand(ENEMY_SIZE,SCREEN_WIDTH-ENEMY_SIZE),e.y=0-e.height;this.timer%30===0&&(s=this.timer/60,o=Math.rand(0,s),this.enemyGroup.children.each(function(t){return function(e){var i,n;if(o>0&&e.y<SCREEN_HEIGHT/2){if(o--,n=Bullet("red","black",15,10).addChildTo(t.enemyBulletGroup),n.position.set(e.x,e.y+30),i=Math.rand(0,50),0===i)return n.fillStyle="#AA0000",n.update=function(){var t;t=tm.geom.Vector2.random(0,180,this.speed),this.x+=t.x,this.y+=t.y,(this.x<0||SCREEN_WIDTH<this.x)&&"function"==typeof this&&this(remove()),(this.y<0||SCREEN_HEIGHT+this.height<this.y)&&"function"==typeof this&&this(remove())};if(i>=1&&6>=i)return n.fillStyle="#CC3333",n.toAim=tm.geom.Vector2(t.shooter.x-n.x,t.shooter.y-n.y).normalize().mul(n.speed),n.update=function(){this.x+=this.toAim.x,this.y+=this.toAim.y,(this.x<0||SCREEN_WIDTH<this.x)&&"function"==typeof this&&this(remove()),(this.y<0||SCREEN_HEIGHT+this.height<this.y)&&"function"==typeof this&&this(remove())}}}}(this))),this.enemyGroup.children.each(function(t){return function(e){t.shooterBulletGroup.children.each(function(i){e.isHitElement(i)&&(null!=e&&e.remove(),null!=i&&i.remove(),t.hit++)}),t.shooter.isHitElement(e)&&(null!=e&&e.remove(),t.shooterDied())}}(this)),this.enemyBulletGroup.children.each(function(t){return function(e){t.shooterBulletGroup.children.each(function(i){e.isHitElement(i)&&(null!=e&&e.remove(),i.released&&25===i.sizeGet()||null!=i&&i.remove(),t.bulletHit++)}),t.shooter.isHitElement(e)&&(null!=e&&e.remove(),t.shooterDied())}}(this))},onblur:function(){this.app.pushScene(PauseScene())},shooterDied:function(){tm.sound.SoundManager.stopMusic(),tm.sound.SoundManager.play("died",1,0,!1),this.shooter.canMove=!1,this.shooter.gotoAndPlay("explode"),setTimeout(function(t){return function(){t.app.replaceScene(ResultScene(t.timer,t.hit,t.bulletHit))}}(this),100)}}),tm.define("PauseScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:[{type:"RectangleShape",width:SCREEN_WIDTH,height:SCREEN_HEIGHT,fillStyle:"rgba(0, 0, 0, 0.4)",originX:0,originY:0},{type:"Label",name:"titleLabel",text:"Pause",x:SCREEN_WIDTH/2,y:360,fillStyle:"#FFFFFF",fontSize:60,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"FlatButton",name:"helpButton",init:[{text:"操作方法",fontSize:20,fontFamily:"メイリオ",width:200,height:80}],x:SCREEN_WIDTH/2,y:600},{type:"FlatButton",name:"backButton",init:[{text:"再開する",fontSize:26,fontFamily:"メイリオ"}],x:SCREEN_WIDTH/2,y:800}]}),tm.sound.SoundManager.pauseMusic(),this.helpButton.onpointingstart=function(t){return function(){var t;t=window.open("help.html"),null==t&&window.confirm("途中で確認すると最初からやり直しになりますが、よろしいですか？")&&(document.location="help.html")}}(this),this.backButton.onpointingstart=function(t){return function(){tm.sound.SoundManager.resumeMusic(),t.app.popScene()}}(this)},update:function(t){t.keyboard.getKey("escape")&&this.app.popScene()},onfocus:function(){this.app.start()},onblur:function(){this.app.stop()}}),tm.define("ResultScene",{superClass:"tm.app.Scene",init:function(t,e,i){this.superInit(),this.timeFormated=Math.floor(100*t/30)/100,this.score=t+10*e+i,this.fromJSON({children:[{type:"FlatButton",name:"creditButton",init:[{text:"クレジット",fontSize:14,fontFamily:"メイリオ",width:100,height:40}],x:SCREEN_WIDTH-70,y:40},{type:"Label",name:"titleLabel",text:"Result",x:SCREEN_WIDTH/2,y:300,fillStyle:"#FFFFFF",fontSize:60,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"Label",name:"titleLabel",text:this.timeFormated+"秒 "+(e+i)+"ヒット\n(うち機体: "+e+"ヒット)",x:SCREEN_WIDTH/2,y:375,fillStyle:"#CCCCFF",fontSize:36,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"Label",name:"titleLabel",text:"Score: "+this.score,x:SCREEN_WIDTH/2,y:500,fillStyle:"#CCCCFF",fontSize:36,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"FlatButton",name:"tweetButton",init:[{text:"Twitterでつぶやく",fontSize:22,fontFamily:"メイリオ",width:200,height:80}],x:SCREEN_WIDTH/2,y:600},{type:"FlatButton",name:"backButton",init:[{text:"タイトルに戻る",fontSize:26,fontFamily:"メイリオ"}],x:SCREEN_WIDTH/2,y:800}]}),this.creditButton.onpointingstart=function(t){return function(){t.app.pushScene(CreditScene())}}(this),this.tweetButton.onpointingstart=function(t){return function(){var n,o;o=tm.social.Twitter.createURL({type:"tweet",text:"Shooting! "+t.timeFormated+"秒間生き残り、"+(i+e)+"ヒットしました！(うち機体: "+e+"ヒット) Score: "+t.score,hashtags:"tmlib, shooting!",url:window.document.location.href}),n=window.open(o),null==n&&(document.location=o)}}(this),this.backButton.onpointingstart=function(t){return function(){t.app.replaceScene(TitleScene())}}(this)}}),tm.define("CreditScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:[{type:"RectangleShape",width:SCREEN_WIDTH,height:SCREEN_HEIGHT,fillStyle:"rgba(85, 85, 85, 0.9)",originX:0,originY:0},{type:"Label",name:"titleLabel",text:"Credit",x:SCREEN_WIDTH/2,y:100,fillStyle:"#FFFFFF",fontSize:60,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"Label",name:"titleLabel",text:"--- Build Tools etc. ---\nbower\nnpm\ngulp\n--- Libraries ---\npure\ntmlib.js\n--- Sounds ---\nMusMus",x:SCREEN_WIDTH/2,y:200,fillStyle:"#CCCCFF",fontSize:36,fontFamily:"メイリオ",align:"center",baseline:"middle"},{type:"FlatButton",name:"backButton",init:[{text:"戻る",fontSize:26,fontFamily:"メイリオ",align:"center",baseline:"middle"}],x:SCREEN_WIDTH/2,y:800}]}),this.backButton.onpointingstart=function(t){return function(){t.app.popScene()}}(this)}});var getDirection,isIOS,isMobile;isIOS=function(){return navigator.userAgent.match(/(?:iPhone|iPod|iPad)/)},isMobile=function(){return navigator.userAgent.match(/(?:iPhone|iPod|iPad|Android|Windows Phone|BlackBerry|Mobile|Touch|Tablet)/)},getDirection=function(){var t;if(t=0,null!=window.orientation)switch(window.orientation){case 0:t=0;break;case 90:t=1;break;case 180:t=2;break;case-90:t=3}return t};